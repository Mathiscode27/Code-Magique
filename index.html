<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Code Magique</title>
  <style>
  :root {
    --bg-0: #071129;
    --bg-1: #0b1220;
    --accent: #6366f1;
    --accent-2: #7c3aed;
    --muted: #9aa7bd;
    --glass: rgba(255,255,255,0.03);
    --glass-strong: rgba(255,255,255,0.06);
  }

  * {
    box-sizing: border-box;
    font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  }

  body {
    margin: 0;
    background: linear-gradient(180deg, var(--bg-0), #08182b);
    color: #e9f2ff;
  }

  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    background: var(--bg-1);
    box-shadow: 0 1px 4px rgba(0, 0, 0, .5);
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }

  .logo {
    font-weight: 700;
    font-size: 20px;
    color: var(--accent);
  }

  .search input {
    width: 420px;
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.1);
    background: var(--glass);
    color: #e9f2ff;
    outline: none;
  }

  .search input::placeholder {
    color: var(--muted);
  }

  .actions button {
    margin-left: 8px;
    padding: 8px 12px;
    border-radius: 6px;
    border: 0;
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    color: white;
    font-weight: 600;
    cursor: pointer;
  }

  .hero {
    padding: 28px 20px;
    text-align: center;
  }

  .products {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 18px;
    padding: 20px;
  }

  .card {
    background: var(--bg-1);
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 1px 10px rgba(0, 0, 0, .4);
    border: 1px solid rgba(255,255,255,0.05);
  }

  .card img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 6px;
  }

  .card h4 {
    margin: 10px 0 6px;
    color: #fff;
  }

  .card p {
    color: var(--muted);
    font-size: 15px;
  }

  .card .price {
    font-weight: 700;
    margin-top: 8px;
    color: var(--accent);
  }

  .card .card-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
  }

  .btn {
    padding: 6px 10px;
    border-radius: 6px;
    border: 0;
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    color: white;
    cursor: pointer;
  }
.fav {
  background: none;
  border: none;
  color: white;
  font-size: 28px;
  cursor: pointer;
  transition: color 0.3s, transform 0.2s;
  padding: 4px;
}
.fav:hover {
  transform: scale(1.2);
}
.fav.active {
  color: red;
}

  /* Modal */
  .modal {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, .5);
    padding: 20px;
  }

  .modal.hidden {
    display: none;
  }

  .modal-content {
    background: var(--bg-1);
    padding: 16px;
    border-radius: 8px;
    width: 420px;
    color: #e9f2ff;
    border: 1px solid rgba(255,255,255,0.05);
  }

  .modal-content input,
  .modal-content textarea {
    width: 100%;
    padding: 8px;
    margin: 6px 0;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 6px;
    background: var(--glass);
    color: #e9f2ff;
  }

  .admin-main {
    padding: 20px;
  }

  .admin-panel {
    max-width: 720px;
    margin: 0 auto;
    background: var(--bg-1);
    padding: 16px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.05);
  }

  /* === ADMIN - Style amÃ©liorÃ© pour les cartes produits === */
  .admin-panel .card {
    background: #0b1220; /* mÃªme fond que le thÃ¨me principal */
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
    padding: 16px;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .admin-panel .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.8);
  }

  .admin-panel .card h4 {
    color: #fff;
    font-size: 20px;
    font-weight: 700;
  }

  .admin-panel .card .price {
    color: #7c3aed;
    font-weight: 700;
    font-size: 17px;
  }

  .admin-panel .card p {
    background: #fff;
    color: #000;
    font-size: 18px;
    font-weight: 400;
    padding: 10px;
    border-radius: 8px;
    line-height: 1.4;
  }

  .admin-panel .card .card-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
  }

  .admin-panel .card .card-actions button {
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    font-weight: 600;
    cursor: pointer;
    color: white;
  }

  .admin-panel .card .card-actions .edit {
    background: #facc15;
    color: #000;
  }

  .admin-panel .card .card-actions .delete {
    background: #ef4444;
  }

  /* Styles additionnels pour l'admin */
  .admin-section {
    display: none;
  }

  .admin-section.visible {
    display: block;
  }

  .admin-nav {
    margin-bottom: 20px;
  }

  .admin-nav button.active {
    background: var(--accent);
  }

  @media (max-width:600px) {
    .search input {
      width: 160px;
    }
  }

  /* Style pour login/signup */
  .auth-container {
    background: var(--bg-1);
    width: 800px;
    padding: 0;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.4);
    display: flex;
    position: relative;
    color: #e9f2ff;
  }

  .auth-section {
    flex: 1;
    padding: 40px;
    position: relative;
  }

  .auth-section:first-child {
    border-right: 1px solid rgba(255,255,255,0.08);
  }

  .auth-section h2 {
    margin-bottom: 30px;
    color: var(--accent);
    text-align: center;
    font-size: 24px;
    font-weight: 600;
  }

  .auth-section form {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .auth-section input {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 5px;
    font-size: 14px;
    background: var(--glass);
    color: #e9f2ff;
  }

  .auth-section input:focus {
    border-color: var(--accent);
    outline: none;
  }

  .auth-section button {
    width: 100%;
    padding: 12px;
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background 0.3s;
    margin-top: 10px;
  }

  .auth-section button:hover {
    background: var(--accent-2);
  }

  #closeAuthBtn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--muted);
    z-index: 2;
  }

  @media (max-width: 850px) {
    .auth-container {
      width: 90%;
      flex-direction: column;
    }

    .auth-section:first-child {
      border-right: none;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
  }
</style>
</head>
<body>
  <header class="topbar">
    <div class="logo">Code Magique</div>
    <div class="search">
      <input id="searchInput" placeholder="Rechercher un produit..." />
    </div>
    <div class="actions">
      <button id="favoritesBtn">Favoris</button>
      <button id="cartBtn">Panier ðŸ›’ (<span id="cartCount">0</span>)</button>
      <button id="loginBtn">Se connecter / S'inscrire</button>
      <button id="adminBtn" class="hidden">Admin</button>
      <button id="logoutBtn" class="hidden">DÃ©connexion</button>
    </div>
  </header>

  <main>
    <!-- Section principale -->
    <div id="mainSection">
      <section class="hero">
        <h1>Bienvenue sur Code Magique</h1>
      </section>

      <section class="products" id="products"></section>
    </div>

    <!-- Section admin -->
    <div id="adminSection" class="admin-section">
      <div class="admin-main">
        <section class="admin-panel">
          <h2>Administration</h2>
          
          <!-- Formulaire d'ajout -->
          <h3>Ajouter un produit</h3>
          <form id="addProductForm">
            <input name="title" placeholder="Titre" required />
              <input name="price" type="number" step="0.01" placeholder="Prix (EUR)" required />
            <textarea name="description" placeholder="Description"></textarea>
            <label>Image: <input type="file" name="image" accept="image/*" /></label>
            <label>Document: <input type="file" name="document" /></label>
            <button type="submit" class="btn">Ajouter le produit</button>
          </form>
          <div id="addResult"></div>

          <!-- Liste des produits -->
          <h3 style="margin-top:30px">GÃ©rer les produits</h3>
          <div id="adminProductsList" style="margin-top:20px"></div>
        </section>
      </div>
    </div>
  </main>

  <!-- Modals -->
  <div id="authModal" class="modal hidden">
    <div class="modal-content auth-container">
      <button id="closeAuthBtn">âœ•</button>

      <div class="auth-section">
        <h2>Se connecter</h2>
        <form id="loginForm">
          <input id="loginIdentifier" type="text" name="identifier" placeholder="Email ou nom d'utilisateur" required />
          <input id="loginPassword" type="password" name="pswd" placeholder="Mot de passe" required />
          <button type="submit">Se connecter</button>
          <p style="text-align:center;margin-top:10px">
            <a href="#" id="forgotPasswordLink" style="color:var(--accent);text-decoration:none;">Mot de passe oubliÃ© ?</a>
          </p>
        </form>
      </div>

      <div class="auth-section">
        <h2>S'inscrire</h2>
        <form id="signupForm">
          <input id="signupUsername" type="text" name="txt" placeholder="Nom d'utilisateur" required />
          <input id="signupEmail" type="email" name="email" placeholder="Email" required />
          <input id="signupPassword" type="password" name="pswd" placeholder="Mot de passe" required />
          <button type="submit">S'inscrire</button>
        </form>
      </div>
    </div>
  </div>

  <div id="cartModal" class="modal hidden">
    <div class="modal-content">
      <h3>Panier ðŸ›’</h3>
      <div id="cartItems"></div>
      <div class="cart-total">
        Total: â‚¬<span id="cartTotal">0.00</span>
      </div>

      <!-- Bouton payer -->
      <button id="payNowBtn" class="btn" style="width:100%;margin-top:10px">
        ðŸ’³ Payer
      </button>

      <!-- Zone oÃ¹ apparaÃ®tront les boutons de paiement -->
      <div id="paymentSection" style="margin-top:15px;display:none">
        <h4>Paiement sÃ©curisÃ©</h4>
        <div id="cardPayment" style="margin-top:10px"></div>
        <div id="paypalButtons" style="margin-top:15px"></div>
      </div>

      <button id="closeCart" style="margin-top:20px">Fermer</button>
    </div>
  </div>

  <div id="favoritesModal" class="modal hidden">
    <div class="modal-content">
      <h3>Favoris</h3>
      <div id="favoritesList"></div>
      <button id="closeFav">Fermer</button>
    </div>
  </div>

  <div id="forgotModal" class="modal hidden">
  <div class="modal-content" style="max-width:400px;text-align:center">
    <h3>RÃ©initialiser le mot de passe</h3>
    <p>Entrez votre adresse e-mail pour recevoir un lien de rÃ©initialisation.</p>
    <input id="forgotEmail" type="email" placeholder="Votre email" required style="width:100%;padding:10px;margin:10px 0;border-radius:5px;border:1px solid rgba(255,255,255,0.1);background:var(--glass);color:white;">
    <button id="sendResetEmail" class="btn">Envoyer</button>
    <button id="closeForgot" class="btn" style="background:#6c757d;margin-top:10px">Annuler</button>
    <div id="forgotResult" style="margin-top:10px;color:#9aa7bd"></div>
  </div>
</div>


  <script>
    // Ã‰tat global
    const API = '/api';
    let currentUser = null;
    let token = localStorage.getItem('pv_token');
    if (token) try { currentUser = JSON.parse(atob(token.split('.')[1])); } catch(e) {}

    // Ã‰lÃ©ments DOM
    const dom = {
      products: document.getElementById('products'),
        loginBtn: document.getElementById('loginBtn'),
        logoutBtn: document.getElementById('logoutBtn'),
        adminBtn: document.getElementById('adminBtn'),
        authModal: document.getElementById('authModal'),
        closeAuthBtn: document.getElementById('closeAuthBtn'),
      cartBtn: document.getElementById('cartBtn'),
      cartModal: document.getElementById('cartModal'),
      cartItems: document.getElementById('cartItems'),
      cartTotal: document.getElementById('cartTotal'),
      cartCount: document.getElementById('cartCount'),
      closeCart: document.getElementById('closeCart'),
      favoritesBtn: document.getElementById('favoritesBtn'),
      favoritesModal: document.getElementById('favoritesModal'),
      favoritesList: document.getElementById('favoritesList'),
      closeFav: document.getElementById('closeFav'),
      searchInput: document.getElementById('searchInput'),
      mainSection: document.getElementById('mainSection'),
      adminSection: document.getElementById('adminSection'),
      addProductForm: document.getElementById('addProductForm'),
      addResult: document.getElementById('addResult')
    };

    // Helpers
    async function api(path, opts={}){
      opts.headers = opts.headers || {};
      if (token) opts.headers['Authorization'] = 'Bearer ' + token;
      const res = await fetch(API + path, opts);
      return res.json();
    }

    function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    function showModal(modal){ modal.classList.remove('hidden'); }
    function hideModal(modal){ modal.classList.add('hidden'); }

    // Gestion interface admin
    function updateAuthUI() {
      const isAdmin = currentUser && currentUser.is_admin;
      console.log('Current user:', currentUser); // Pour le dÃ©bogage
      dom.loginBtn.style.display = token ? 'none' : 'block';
      dom.logoutBtn.style.display = token ? 'block' : 'none';
      dom.adminBtn.style.display = isAdmin ? 'block' : 'none';
      
      if (isAdmin) {
        dom.adminBtn.classList.remove('hidden');
        if (location.hash === '#admin') {
          dom.mainSection.style.display = 'none';
          dom.adminSection.style.display = 'block';
        } else {
          dom.mainSection.style.display = 'block';
          dom.adminSection.style.display = 'none';
        }
      } else {
        dom.adminBtn.classList.add('hidden');
        dom.mainSection.style.display = 'block';
        dom.adminSection.style.display = 'none';
      }
    }

    // Ã‰couter les changements de hash pour admin
    window.addEventListener('hashchange', updateAuthUI);
    dom.adminBtn.addEventListener('click', () => {
      location.hash = '#admin';
      updateAuthUI();
    });

    // Navigation
    dom.logoutBtn.addEventListener('click', () => {
      localStorage.removeItem('pv_token');
      token = null;
      currentUser = null;
      location.hash = '';
      updateAuthUI();
      loadProducts();
    });

    // Auth
    dom.loginBtn.addEventListener('click', () => showModal(dom.authModal));
    // close button inside modal
    dom.closeAuthBtn.addEventListener('click', () => hideModal(dom.authModal));

    // Signup form handler
    document.getElementById('signupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('signupEmail').value;
      const password = document.getElementById('signupPassword').value;
      const username = document.getElementById('signupUsername').value;
      const data = await api('/register', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ email, password, username })
      });
      if (data.token) {
        token = data.token;
        currentUser = JSON.parse(atob(token.split('.')[1]));
        localStorage.setItem('pv_token', token);
        hideModal(dom.authModal);
        updateAuthUI();
        refreshCartCount();
        loadProducts();
      } else {
        alert(data.error || 'Erreur inscription');
      }
    });

    // Login form handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      // Lire le champ d'identifiant (email ou nom d'utilisateur)
      const identifier = document.getElementById('loginIdentifier').value;
      const password = document.getElementById('loginPassword').value;
      const payload = { 
        // Si l'identifiant contient @, c'est un email, sinon c'est un nom d'utilisateur
        [identifier.includes('@') ? 'email' : 'username']: identifier,
        password 
      };
      const data = await api('/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (data.token) {
        token = data.token;
        currentUser = JSON.parse(atob(token.split('.')[1]));
        localStorage.setItem('pv_token', token);
        hideModal(dom.authModal);
        updateAuthUI();
        refreshCartCount();
        loadProducts();
      } else {
        alert(data.error || 'Erreur connexion');
      }
    });
    // === MOT DE PASSE OUBLIÃ‰ ===
const forgotModal = document.getElementById('forgotModal');
const forgotLink = document.getElementById('forgotPasswordLink');
const closeForgot = document.getElementById('closeForgot');
const sendResetEmail = document.getElementById('sendResetEmail');
const forgotEmail = document.getElementById('forgotEmail');
const forgotResult = document.getElementById('forgotResult');

// Ouvrir la modale
forgotLink.addEventListener('click', (e) => {
  e.preventDefault();
  hideModal(dom.authModal); // on ferme la modale de login
  showModal(forgotModal);
});

// Fermer la modale
closeForgot.addEventListener('click', () => hideModal(forgotModal));

// Envoyer la demande de rÃ©initialisation
sendResetEmail.addEventListener('click', async () => {
  const email = forgotEmail.value.trim();
  if (!email) {
    forgotResult.style.color = 'red';
    forgotResult.innerText = "Veuillez entrer un email.";
    return;
  }
  
  try {
    forgotResult.style.color = '#9aa7bd';
    forgotResult.innerText = "Envoi en cours...";
    
    const res = await fetch('/api/forgot-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });
    const data = await res.json();
    
    if (res.ok) {
      forgotResult.style.color = 'lightgreen';
      forgotResult.innerText = "Un lien de rÃ©initialisation a Ã©tÃ© envoyÃ© Ã  votre adresse email.";
    } else {
      forgotResult.style.color = 'red';
      forgotResult.innerText = data.error || "Erreur lors de l'envoi de l'email.";
    }
  } catch (err) {
    forgotResult.style.color = 'red';
    forgotResult.innerText = "Erreur rÃ©seau : " + err.message;
  }
  });


    // Admin: charger la liste des produits dans le panel admin
    async function loadAdminProducts() {
      if (!currentUser?.is_admin) return;
      const items = await api('/products');
      const container = document.getElementById('adminProductsList');
      container.innerHTML = items.map(p => `
        <div style="display:flex;gap:10px;align-items:center;padding:12px;border-bottom:1px solid #eee;background:var(--bg-1);margin-bottom:8px;border-radius:4px">
          <img src="${p.image||'https://via.placeholder.com/80'}" style="width:80px;height:50px;object-fit:cover;border-radius:4px"/>
          <div style="flex:1">
            <b>${escapeHtml(p.title||'Sans titre')}</b>
            <div>${Number(p.price||0).toFixed(2)} â‚¬</div>
            <div style="color:white;font-size:15px">${escapeHtml((p.description||'').slice(0,100))}...</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn" style="background:#ffc107;color:#000" onclick="editProduct(${p.id})">Modifier</button>
            <button class="btn" style="background:#dc3545" onclick="deleteProduct(${p.id})">Supprimer</button>
          </div>
        </div>
      `).join('') || '<p>Aucun produit</p>';
    }

    // Admin: supprimer un produit
    async function deleteProduct(id) {
      if (!currentUser?.is_admin) return;
      if (!confirm('ÃŠtes-vous sÃ»r de vouloir supprimer ce produit ?')) return;
      
      try {
        const result = await fetch(API + '/products/' + id, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });
        
        if (!result.ok) {
          const text = await result.text();
          throw new Error(text || 'Erreur rÃ©seau');
        }
        
        const data = await result.json();
        
        if (data.success) {
          alert('Produit supprimÃ© !');
          loadAdminProducts(); // RafraÃ®chir la liste admin
          loadProducts();     // RafraÃ®chir la liste publique
        } else {
          throw new Error(data.error || 'Erreur inconnue');
        }
      } catch (err) {
        alert('Erreur: ' + (err.message || err));
      }
    }

    // Admin: ajout produit
    dom.addProductForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser?.is_admin) return;
      
      const form = e.target;
      const fd = new FormData(form);
      
      try {
        const res = await fetch('/api/products', { 
          method: 'POST', 
          headers: { Authorization: 'Bearer ' + token }, 
          body: fd 
        });

        if (!res.ok) throw new Error('Erreur rÃ©seau');
        
        const data = await res.json();
        if (!data.id) throw new Error(data.error || 'Erreur inconnue');
        
        dom.addResult.style.color = 'green';
        dom.addResult.innerText = 'Produit ajoutÃ© avec succÃ¨s !';
        form.reset();
        loadProducts();
        loadAdminProducts();
        
      } catch (err) {
        dom.addResult.style.color = 'red';
        dom.addResult.innerText = 'Erreur : ' + (err.message || err);
      }
    });

    // Catalogue produits
    async function loadProducts(){
      const items = await api('/products');
      renderProducts(items || []);
    }

    async function renderProducts(items){
  dom.products.innerHTML = '';
  
  // On rÃ©cupÃ¨re les favoris actuels pour colorer les bons cÅ“urs
  let favorites = [];
  if (token) {
    try {
      favorites = await api('/favorites');
    } catch (err) {
      console.warn('Erreur chargement favoris:', err);
    }
  }

  const favIds = favorites.map(f => f.id);

  items.forEach(p => {
    const el = document.createElement('div');
    el.className = 'card';
    const isFav = favIds.includes(p.id);

    el.innerHTML = `
      <img src="${p.image || 'https://via.placeholder.com/300x150?text=No+Image'}" />
      <h4>${escapeHtml(p.title||'Sans titre')}</h4>
      <p>${escapeHtml((p.description||'')).slice(0,120)}</p>
      <div class="price">
        ${!p.price || Number(p.price) === 0 ? 'Gratuit' : `â‚¬${Number(p.price).toFixed(2)}`}
      </div>
      <div class="card-actions">
        <div>
          <button class="btn addCart" data-id="${p.id}">Ajouter</button>
          <button class="fav ${isFav ? 'active' : ''}" data-id="${p.id}">â™¥</button>
        </div>
        <div>
          <button class="btn open" data-id="${p.id}">DÃ©tails</button>
        </div>
      </div>
    `;
    dom.products.appendChild(el);
  });

      // Event listeners produits
      document.querySelectorAll('.addCart').forEach(b => b.addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        if (!token) return showModal(dom.authModal);
        await api('/cart/add', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ product_id: id, qty:1 })
        });
        refreshCartCount();
        alert('AjoutÃ© au Panier ðŸ›’');
      }));

     document.querySelectorAll('.fav').forEach(b => 
  b.addEventListener('click', async (e) => {
    const btn = e.target;
    const id = btn.dataset.id;
    if (!token) return showModal(dom.authModal);

    await api('/favorites/toggle', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ product_id: id })
    });

    // Bascule la couleur du cÅ“ur et animation
    btn.classList.toggle('active');
    btn.animate([{ transform: 'scale(1.2)' }, { transform: 'scale(1)' }], { duration: 200 });
  })
);

      document.querySelectorAll('.open').forEach(b => b.addEventListener('click', (e) => {
        const id = e.target.dataset.id;
        openProduct(id);
      }));
    }

// === PANIER ===
dom.cartBtn.addEventListener('click', async () => {
  if (!token) return showModal(dom.authModal);
  showModal(dom.cartModal);
  await refreshCartModal();
});

// Attacher le listener une seule fois ici
const payNowBtn = document.getElementById('payNowBtn');
const paymentSection = document.getElementById('paymentSection');

payNowBtn.addEventListener('click', async () => {
  const total = parseFloat(dom.cartTotal.innerText);
  if (total <= 0) {
    alert('Votre panier est vide.');
    return;
  }
  paymentSection.style.display = 'block';
  renderSecurePayment(total);
});

// --- Fonction principale de paiement sÃ©curisÃ© ---
function renderSecurePayment(total) {
  const cardDiv = document.getElementById('cardPayment');
  const paypalDiv = document.getElementById('paypalButtons');
  cardDiv.innerHTML = '';
  paypalDiv.innerHTML = '';

  // === Carte bancaire (intÃ©gration Stripe Elements simulÃ©e) ===
  cardDiv.innerHTML = `
    <form id="fakeCardForm" style="display:flex;flex-direction:column;gap:10px;margin-top:10px">
      <input type="text" placeholder="NumÃ©ro de carte" required maxlength="19" style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:var(--glass);color:white" />
      <div style="display:flex;gap:10px">
        <input type="text" placeholder="MM/AA" required maxlength="5" style="flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:var(--glass);color:white" />
        <input type="text" placeholder="CVC" required maxlength="3" style="flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);background:var(--glass);color:white" />
      </div>
      <button type="submit" class="btn" style="width:100%">ðŸ’³ Valider le paiement</button>
    </form>
    <div id="cardResult" style="margin-top:8px;color:#9aa7bd"></div>
  `;

  const cardForm = document.getElementById('fakeCardForm');
  const cardResult = document.getElementById('cardResult');

  cardForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    cardResult.innerText = 'ðŸ”’ Paiement sÃ©curisÃ© en cours...';
    setTimeout(() => {
      cardResult.style.color = 'lightgreen';
      cardResult.innerText = 'âœ… Paiement acceptÃ© avec succÃ¨s !';
      // Ici on viderait le panier cÃ´tÃ© serveur
    }, 2000);
  });

  // === PayPal (intÃ©gration officielle) ===
  const script = document.createElement('script');
  script.src = "https://www.paypal.com/sdk/js?client-id=sb&currency=EUR";
  script.onload = () => {
    paypal.Buttons({
      style: { color: 'gold', shape: 'rect', label: 'pay' },
      createOrder: (data, actions) => actions.order.create({
        purchase_units: [{ amount: { value: total.toFixed(2) } }]
      }),
      onApprove: (data, actions) =>
        actions.order.capture().then(() => {
          alert('âœ… Paiement PayPal confirmÃ© !');
          paymentSection.style.display = 'none';
        })
    }).render('#paypalButtons');
  };
  document.body.appendChild(script);
}

dom.closeCart.addEventListener('click', () => hideModal(dom.cartModal));

// --- Compteur du panier ---
async function refreshCartCount() {
  if (!token) {
    dom.cartCount.innerText = '0';
    return;
  }
  const items = await api('/cart');
  dom.cartCount.innerText = items.length || 0;
}

// --- Actualisation du contenu du panier ---
async function refreshCartModal() {
  const items = await api('/cart');
  
  dom.cartItems.innerHTML = items.map(i => `
    <div style="display:flex;gap:10px;align-items:center;padding:6px;border-bottom:1px solid #eee">
      <img src="${i.image || 'https://via.placeholder.com/80'}"
           style="width:80px;height:50px;object-fit:cover"/>
      <div style="flex:1">
        <b>${i.title}</b>
        <div>â‚¬${Number(i.price).toFixed(2)}</div>
        <div style="margin-top:6px;display:flex;align-items:center;gap:8px">
          <button class="btn dec" data-id="${i.id}">âˆ’</button>
          <span class="qty">${i.qty}</span>
          <button class="btn inc" data-id="${i.id}">+</button>
        </div>
      </div>
      <button class="btn remove" data-id="${i.id}">Supprimer</button>
    </div>
  `).join('');

  // --- Suppression dâ€™un article ---
  document.querySelectorAll('.remove').forEach(b => b.addEventListener('click', async e => {
    const id = e.target.dataset.id;
    await api('/cart/remove',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({product_id:e.target.dataset.id})
    });
    await refreshCartModal();
    refreshCartCount();
  }));

  // --- IncrÃ©mentation quantitÃ© ---
  document.querySelectorAll('.inc').forEach(b => b.addEventListener('click', async e => {
    const id = e.target.dataset.id;
    await api('/cart/add',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({product_id:e.target.dataset.id, qty:1})
    });
    await refreshCartModal();
    refreshCartCount();
  }));

  // --- DÃ©crÃ©mentation quantitÃ© ---
  document.querySelectorAll('.dec').forEach(b => b.addEventListener('click', async e => {
    const id = e.target.dataset.id;
    await api('/cart/add',{
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({product_id:e.target.dataset.id, qty:-1})
    });
    await refreshCartModal();
    refreshCartCount();
  }));

  // --- Calcul du total ---
  const total = items.reduce((s, i) => s + (i.price || 0) * i.qty, 0);
  dom.cartTotal.innerText = total.toFixed(2);

  // --- Boutons PayPal ---
  renderPayPalButtons(total);
}


    // Favoris
    dom.favoritesBtn.addEventListener('click', async () => {
      if (!token) return showModal(dom.authModal);
      showModal(dom.favoritesModal);
      const favs = await api('/favorites');
      dom.favoritesList.innerHTML = favs.map(p => `
        <div class="card" style="margin-bottom:8px">
          <img src="${p.image||'https://via.placeholder.com/150'}" style="height:50px;width:80px;object-fit:cover;float:left;margin-right:8px"/>
          <div>
            <b>${p.title}</b>
          <div>â‚¬${Number(p.price||0).toFixed(2)}</div>
          </div>
        </div>
      `).join('');
    });
    dom.closeFav.addEventListener('click', () => hideModal(dom.favoritesModal));

    // PayPal
    function renderPayPalButtons(total) {
      const payDiv = document.getElementById('paypalButtons');
      payDiv.innerHTML = '';
      if (!total || total <= 0) return;
      payDiv.appendChild(script1);
      payDiv.appendChild(script2);
    }


    // Recherche
    dom.searchInput.addEventListener('input', async (e) => {
      const q = e.target.value.toLowerCase();
      const items = await api('/products');
      const filtered = items.filter(p => 
        (p.title||'').toLowerCase().includes(q) || 
        (p.description||'').toLowerCase().includes(q)
      );
      renderProducts(filtered);
    });

    // DÃ©tails produit + avis
    async function openProduct(id){
      const prods = await api('/products');
      const p = prods.find(x => String(x.id) === String(id));
      if (!p) return alert('Produit introuvable');

      const box = document.createElement('div');
      box.className = 'modal';
      box.innerHTML = `
        <div class="modal-content">
          <h3>${escapeHtml(p.title)}</h3>
          <img src="${p.image||'https://via.placeholder.com/400x200'}" style="width:100%;height:180px;object-fit:cover"/>
          <p>${escapeHtml(p.description)}</p>
            <div>Prix: â‚¬${Number(p.price).toFixed(2)}</div>
          <div style="margin-top:10px">
            <button class="btn addCartNow">Ajouter au Panier ðŸ›’</button>
            <button class="btn addReview">Laisser un avis</button>
            <button class="btn closeModal">Fermer</button>
          </div>
          <div id="reviewsArea"></div>
        </div>
      `;

      document.body.appendChild(box);
      box.querySelector('.closeModal').addEventListener('click', () => box.remove());
      box.querySelector('.addCartNow').addEventListener('click', async () => {
        if (!token) return showModal(dom.authModal);
        await api('/cart/add', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ product_id: p.id, qty:1 })
        });
        alert('AjoutÃ©');
        refreshCartCount();
      });

      box.querySelector('.addReview').addEventListener('click', async () => {
        if (!token) return showModal(dom.authModal);
        const rating = prompt('Note (1-5)');
        if (!rating) return;
        const comment = prompt('Commentaire');
        if (!comment) return;
        await api('/reviews', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ product_id: p.id, rating: Number(rating)||5, comment })
        });
        alert('Merci pour votre avis');
        // Recharger les avis
        const reviews = await api('/reviews/' + p.id);
        const area = box.querySelector('#reviewsArea');
        area.innerHTML = '<h4>Avis</h4>' + (
          reviews.map(r => `
            <div style="border-top:1px solid #eee;padding:6px">
              <b>${r.username||'Anonyme'}</b> - ${'â˜…'.repeat(r.rating)}
              <div>${escapeHtml(r.comment||'')}</div>
            </div>
          `).join('') || 'Aucun avis'
        );
      });

      // Charger les avis
      const reviews = await api('/reviews/' + p.id);
      const area = box.querySelector('#reviewsArea');
      area.innerHTML = '<h4>Avis</h4>' + (
        reviews.map(r => `
          <div style="border-top:1px solid #eee;padding:6px">
            <b>${r.username||'Anonyme'}</b> - ${'â˜…'.repeat(r.rating)}
            <div>${escapeHtml(r.comment||'')}</div>
          </div>
        `).join('') || 'Aucun avis'
      );
    }

    // Admin: Ã©diter un produit
    async function editProduct(id) {
      if (!currentUser?.is_admin) return;
      
      const styleInput = "width:100%;padding:10px;border:1px solid #ddd;border-radius:4px";
      const styleLabel = "display:block;margin-bottom:8px;font-weight:500";
      
      // RÃ©cupÃ©rer les donnÃ©es du produit
      const products = await api('/products');
      const product = products.find(p => p.id === id);
      if (!product) {
        alert('Produit non trouvÃ©');
        return;
      }

      // CrÃ©er et afficher le modal d'Ã©dition
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="width:90%;max-width:800px;padding:30px;max-height:90vh;overflow:auto;position:relative">
            <button onclick="this.closest('.modal').remove()" 
            style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:5px;z-index:1">âœ•</button>
            
            <h3 style="margin:0 0 20px 0">Modifier le produit</h3>
            
            <form id="editProductForm" style="display:flex;flex-direction:column;gap:15px">
            <div style="margin-bottom:15px">
                <label style="display:block;margin-bottom:8px">Titre du produit</label>
                <input name="title" placeholder="Titre" value="${escapeHtml(product.title || '')}" required 
                style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px" />
            </div>

            <div style="margin-bottom:15px">
                <label style="display:block;margin-bottom:8px">Prix (â‚¬)</label>
                <input name="price" type="number" step="0.01" placeholder="Prix en euros" value="${product.price || ''}" required 
                style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px" />
            </div>

            <div style="margin-bottom:15px">
                <label style="display:block;margin-bottom:8px">Description</label>
                <textarea name="description" placeholder="Description dÃ©taillÃ©e du produit" 
                style="width:100%;min-height:100px;padding:10px;border:1px solid #ddd;border-radius:4px;resize:vertical"
                >${escapeHtml(product.description || '')}</textarea>
            </div>

            <div style="margin-bottom:15px">
                <label style="display:block;margin-bottom:8px">Image du produit</label>
                <div style="padding:10px;border-radius:4px">
                ${product.image ? 
                    `<img src="${product.image}" style="max-width:200px;max-height:150px;display:block;margin:0 0 10px 0;object-fit:contain" />` 
                    : '<p style="color:#666;margin:0">Aucune image</p>'}
                <input type="file" name="image" accept="image/*" style="margin-top:10px" />
                </div>
            </div>

            <div style="margin-bottom:15px">
                <label style="display:block;margin-bottom:8px">Document associÃ©</label>
                <div style="padding:10px;border-radius:4px">
                ${product.document ? 
                    `<a href="${product.document}" target="_blank" class="btn" style="display:inline-block;padding:8px 12px;margin-bottom:10px">Voir le document actuel</a>` 
                    : '<p style="color:#666;margin:0">Aucun document</p>'}
                <input type="file" name="document" style="margin-top:10px" />
                </div>
            </div>

            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
                <button type="button" class="btn" style="background:#6c757d;padding:10px 20px" 
                onclick="this.closest('.modal').remove()">Annuler</button>
                <button type="submit" class="btn" style="padding:10px 20px">Enregistrer</button>
            </div>
            </form>
            <div id="editResult" style="margin-top:15px"></div>
        </div>
        `;

      document.body.appendChild(modal);

      // GÃ©rer la soumission du formulaire
      const form = modal.querySelector('#editProductForm');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
          const formData = new FormData(form);
          
          // Si pas de nouveau fichier, ne pas envoyer les champs file vides
          if (!formData.get('image').size) formData.delete('image');
          if (!formData.get('document').size) formData.delete('document');

          const response = await fetch(`/api/products/${id}`, {
            method: 'PUT',
            headers: {
              'Authorization': 'Bearer ' + token
            },
            body: formData
          });

          if (!response.ok) {
            throw new Error('Erreur rÃ©seau');
          }

          const result = await response.json();
          if (result.error) {
            throw new Error(result.error);
          }

          alert('Produit modifiÃ© avec succÃ¨s !');
          modal.remove();
          loadProducts();
          loadAdminProducts();
        } catch (error) {
          const resultDiv = modal.querySelector('#editResult');
          resultDiv.style.color = 'red';
          resultDiv.textContent = 'Erreur: ' + (error.message || error);
        }
      });
    }

    // Initialisation
    updateAuthUI();
    loadProducts();
    refreshCartCount();
    if (currentUser?.is_admin) loadAdminProducts();
  </script>
</body>
</html>
